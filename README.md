# Cloudproof

## Installation

```
flutter pub get cloudproof
```

## Example

To run the example, you need a Redis server configured and populated with our [Java example](https://github.com/Cosmian/cosmian_java_lib) (`docker compose up` then `mvn test`). Then, update `redisHost` and `redisPort` at the top of the `example/lib/main.dart` file.

## Usage

### CoverCrypt

CoverCrypt allows to decrypt data previously encrypted with one of our libraries (Java, Python, Rust…).

Two classes are available: `CoverCryptDecryption` and `CoverCryptDecryptionWithCache` which is a little bit faster (omit the initialisation phase during decryption). See `test/covercrypt_test.dart`.

### Findex

Findex allows to do encrypted search queries on an encrypted index. To use Findex you need a driver which is able to store and update indexes (it could be SQLite, Redis, or any other storage method).

To search, you need:
1. copy/paste the following lines
2. replace `TODO_ReplaceThisByTheNameOfYourClassOrTheRawFunction` by the name of your class
3. implement `fetchEntries` and `fetchChains`

```dart
  static Future<Map<Uint8List, Uint8List>> fetchEntries(
    List<Uint8List> uids,
  ) async {
    // Implement me!
  }

  static Future<Map<Uint8List, Uint8List>> fetchChains(
    List<Uint8List> uids,
  ) async {
    // Implement me!
  }

  // --------------------------------------------------
  // Copy-paste code :AutoGeneratedImplementation
  // --------------------------------------------------

  static Future<List<IndexedValue>> search(
    Uint8List keyK,
    Uint8List label,
    List<Word> words,
  ) async {
    return await Findex.search(
      keyK,
      label,
      words,
      Pointer.fromFunction(
        fetchEntriesCallback,
        errorCodeInCaseOfCallbackException,
      ),
      Pointer.fromFunction(
        fetchChainsCallback,
        errorCodeInCaseOfCallbackException,
      ),
    );
  }

  static int fetchEntriesCallback(
    Pointer<Uint8> outputPointer,
    Pointer<Uint32> outputLength,
    Pointer<Uint8> entriesUidsListPointer,
    int entriesUidsListLength,
  ) {
    return Findex.fetchWrapper(
      outputPointer,
      outputLength,
      entriesUidsListPointer,
      entriesUidsListLength,
      TODO_ReplaceThisByTheNameOfYourClassOrTheRawFunction.fetchEntries,
    );
  }

  static int fetchChainsCallback(
    Pointer<Uint8> outputPointer,
    Pointer<Uint32> outputLength,
    Pointer<Uint8> chainsUidsListPointer,
    int chainsUidsListLength,
  ) {
    return Findex.fetchWrapper(
      outputPointer,
      outputLength,
      chainsUidsListPointer,
      chainsUidsListLength,
      TODO_ReplaceThisByTheNameOfYourClassOrTheRawFunction.fetchChains,
    );
  }
```

To upsert, you need:
1. copy/paste the following lines
2. replace `TODO_ReplaceThisByTheNameOfYourClassOrTheRawFunction` by the name of your class
3. implement `fetchEntries`, `upsertEntries` and `upsertChains`

```dart
  static Future<void> upsertEntries(Map<Uint8List, Uint8List> entries) async {
    // Implement me!
  }

  static Future<void> upsertChains(Map<Uint8List, Uint8List> chains) async {
    // Implement me!
  }

  // --------------------------------------------------
  // Copy-paste code :AutoGeneratedImplementation
  // --------------------------------------------------

  static Future<void> upsert(
    MasterKeys masterKeys,
    Uint8List label,
    Map<IndexedValue, List<Word>> indexedValuesAndWords,
  ) async {
    await Findex.upsert(
      masterKeys,
      label,
      indexedValuesAndWords,
      Pointer.fromFunction(
        fetchEntriesCallback,
        errorCodeInCaseOfCallbackException,
      ),
      Pointer.fromFunction(
        upsertEntriesCallback,
        errorCodeInCaseOfCallbackException,
      ),
      Pointer.fromFunction(
        upsertChainsCallback,
        errorCodeInCaseOfCallbackException,
      ),
    );
  }

  static int fetchEntriesCallback(
    Pointer<Uint8> outputPointer,
    Pointer<Uint32> outputLength,
    Pointer<Uint8> entriesUidsListPointer,
    int entriesUidsListLength,
  ) {
    return Findex.fetchWrapper(
      outputPointer,
      outputLength,
      entriesUidsListPointer,
      entriesUidsListLength,
      TODO_ReplaceThisByTheNameOfYourClassOrTheRawFunction.fetchEntries,
    );
  }

  static int upsertEntriesCallback(
    Pointer<Uint8> entriesListPointer,
    int entriesListLength,
  ) {
    return Findex.upsertWrapper(
      entriesListPointer,
      entriesListLength,
      TODO_ReplaceThisByTheNameOfYourClassOrTheRawFunction.upsertEntries,
    );
  }

  static int upsertChainsCallback(
    Pointer<Uint8> chainsListPointer,
    int chainsListLength,
  ) {
    return Findex.upsertWrapper(
      chainsListPointer,
      chainsListLength,
      TODO_ReplaceThisByTheNameOfYourClassOrTheRawFunction.upsertChains,
    );
  }
```

#### ⚠️⚠️⚠️ WARNINGS ⚠️⚠️⚠️

- `fetchEntries`, `fetchChains`, `upsertEntries` and `upsertChains` can be static methods in a class or raw functions but should be static! You cannot put classic methods of an instance here.
- `fetchEntries`, `fetchChains`, `upsertEntries` and `upsertChains` cannot access the state of the program, they will run in a separate `Isolate` with no data from the main thread (for example static/global variables populated during an initialisation phase of your program will not exist).


## FFI libs notes

### Building `.so`, `.a`…

If building with `cargo lipo` on Linux we only get `aarch64-apple-ios` and `x86_64-apple-ios`.

On codemagic.io:
- `aarch64-apple-ios` is failing with "ld: in /Users/builder/clone/ios/libcover_crypt.a(cover_crypt.cover_crypt.aea4b2d2-cgu.0.rcgu.o), building for iOS Simulator, but linking in object file built for iOS, file '/Users/builder/clone/ios/libcover_crypt.a' for architecture arm64"
- `x86_64-apple-ios` is failing with "ld: warning: ignoring file /Users/builder/clone/ios/libcover_crypt.a, building for iOS Simulator-arm64 but attempting to link with file built for iOS Simulator-x86_64"

We need to try with `universal` native lib.

### Generating `.h`

Use cbindgen, do not forget to remove `str` type in `libcover_crypt.h` (last two lines).
